<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>VN Shop Acc ‚Äì Li√™n Qu√¢n Mobile</title>
<link href="https://fonts.googleapis.com/css2?family=Rajdhani:wght@400;600;700&family=Be+Vietnam+Pro:wght@300;400;500;600&display=swap" rel="stylesheet">
<style>
  :root {
    --bg: #050810;
    --surface: #0d1117;
    --surface2: #111827;
    --border: rgba(99,179,237,0.12);
    --accent: #00d4ff;
    --accent2: #7c3aed;
    --gold: #f59e0b;
    --danger: #ef4444;
    --success: #10b981;
    --text: #e2e8f0;
    --muted: #6b7280;
    --glow: 0 0 20px rgba(0,212,255,0.3);
  }
  *{margin:0;padding:0;box-sizing:border-box}
  body{background:var(--bg);color:var(--text);font-family:'Be Vietnam Pro',sans-serif;min-height:100vh;overflow-x:hidden}
  body::before{content:'';position:fixed;inset:0;background:radial-gradient(ellipse 80% 50% at 50% -10%,rgba(0,212,255,0.08),transparent);pointer-events:none;z-index:0}

  /* NAV */
  nav{position:fixed;top:0;width:100%;z-index:100;backdrop-filter:blur(20px);background:rgba(5,8,16,0.85);border-bottom:1px solid var(--border);padding:0 24px}
  .nav-inner{max-width:1200px;margin:0 auto;height:60px;display:flex;align-items:center;justify-content:space-between}
  .logo{font-family:'Rajdhani',sans-serif;font-size:1.6rem;font-weight:700;color:var(--accent);letter-spacing:2px;text-shadow:var(--glow)}
  .logo span{color:var(--gold)}
  .nav-right{display:flex;align-items:center;gap:12px}
  .btn{display:inline-flex;align-items:center;gap:8px;padding:8px 16px;border-radius:8px;border:none;cursor:pointer;font-family:'Be Vietnam Pro',sans-serif;font-size:.85rem;font-weight:500;transition:all .2s}
  .btn-outline{background:transparent;border:1px solid var(--border);color:var(--text)}
  .btn-outline:hover{border-color:var(--accent);color:var(--accent)}
  .btn-primary{background:linear-gradient(135deg,var(--accent),var(--accent2));color:#fff;box-shadow:0 4px 15px rgba(0,212,255,0.25)}
  .btn-primary:hover{transform:translateY(-1px);box-shadow:0 6px 20px rgba(0,212,255,0.4)}
  .btn-gold{background:linear-gradient(135deg,#f59e0b,#d97706);color:#000;font-weight:600}
  .btn-danger{background:var(--danger);color:#fff}
  .btn-sm{padding:6px 12px;font-size:.8rem}
  .btn-success{background:var(--success);color:#fff}
  .user-chip{display:flex;align-items:center;gap:8px;background:var(--surface2);border:1px solid var(--border);border-radius:20px;padding:4px 12px 4px 4px;font-size:.82rem}
  .user-avatar{width:28px;height:28px;border-radius:50%;border:2px solid var(--accent)}
  .balance-chip{background:rgba(245,158,11,0.15);border:1px solid rgba(245,158,11,0.3);border-radius:20px;padding:4px 12px;font-size:.82rem;color:var(--gold);font-weight:600}

  /* SECTIONS */
  .section{display:none}
  .section.active{display:block}
  .container{max-width:1200px;margin:0 auto;padding:80px 24px 40px}

  /* HERO */
  .hero{text-align:center;padding:80px 24px 40px;position:relative}
  .hero-title{font-family:'Rajdhani',sans-serif;font-size:clamp(2.2rem,5vw,4rem);font-weight:700;line-height:1.1;margin-bottom:16px}
  .hero-title .hl{background:linear-gradient(135deg,var(--accent),var(--accent2));-webkit-background-clip:text;-webkit-text-fill-color:transparent}
  .hero-sub{color:var(--muted);font-size:1rem;max-width:500px;margin:0 auto 32px}
  .stats-bar{display:flex;justify-content:center;gap:32px;flex-wrap:wrap;margin-top:24px}
  .stat{text-align:center}
  .stat-val{font-family:'Rajdhani',sans-serif;font-size:1.8rem;font-weight:700;color:var(--accent)}
  .stat-lbl{font-size:.75rem;color:var(--muted);text-transform:uppercase;letter-spacing:1px}

  /* FILTER */
  .filter-bar{display:flex;gap:8px;flex-wrap:wrap;margin-bottom:24px}
  .filter-btn{padding:6px 16px;border-radius:20px;border:1px solid var(--border);background:transparent;color:var(--muted);cursor:pointer;font-size:.82rem;transition:all .2s;font-family:'Be Vietnam Pro',sans-serif}
  .filter-btn.active,.filter-btn:hover{border-color:var(--accent);color:var(--accent);background:rgba(0,212,255,0.05)}

  /* ACCOUNTS GRID */
  .grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(280px,1fr));gap:20px}
  .acc-card{background:var(--surface);border:1px solid var(--border);border-radius:16px;overflow:hidden;transition:all .3s;position:relative;cursor:pointer}
  .acc-card:hover{border-color:rgba(0,212,255,0.4);transform:translateY(-4px);box-shadow:0 12px 40px rgba(0,0,0,0.4)}
  .acc-card.sold{opacity:.5;pointer-events:none}
  .card-badge{position:absolute;top:12px;right:12px;padding:3px 10px;border-radius:20px;font-size:.7rem;font-weight:600;z-index:2}
  .badge-new{background:rgba(16,185,129,0.2);color:var(--success);border:1px solid rgba(16,185,129,0.3)}
  .badge-hot{background:rgba(239,68,68,0.2);color:var(--danger);border:1px solid rgba(239,68,68,0.3)}
  .badge-sold{background:rgba(107,114,128,0.3);color:var(--muted)}
  .card-img{width:100%;height:160px;object-fit:cover;background:linear-gradient(135deg,#1a1f2e,#0d1117)}
  .card-img-placeholder{width:100%;height:160px;background:linear-gradient(135deg,#1a2040,#0d1117);display:flex;align-items:center;justify-content:center;font-size:3rem}
  .card-body{padding:16px}
  .card-title{font-family:'Rajdhani',sans-serif;font-size:1.1rem;font-weight:700;margin-bottom:4px}
  .card-desc{font-size:.78rem;color:var(--muted);margin-bottom:12px;line-height:1.5}
  .card-tags{display:flex;gap:4px;flex-wrap:wrap;margin-bottom:12px}
  .tag{padding:2px 8px;border-radius:4px;font-size:.7rem;background:rgba(124,58,237,0.15);color:#a78bfa;border:1px solid rgba(124,58,237,0.2)}
  .card-price{display:flex;align-items:center;justify-content:space-between}
  .price{font-family:'Rajdhani',sans-serif;font-size:1.4rem;font-weight:700;color:var(--gold)}
  .price-currency{font-size:.8rem;color:var(--muted)}

  /* MODAL */
  .modal-overlay{position:fixed;inset:0;background:rgba(0,0,0,0.7);z-index:200;display:none;align-items:center;justify-content:center;padding:16px;backdrop-filter:blur(8px)}
  .modal-overlay.open{display:flex}
  .modal{background:var(--surface);border:1px solid var(--border);border-radius:20px;width:100%;max-width:520px;max-height:90vh;overflow-y:auto;animation:slideUp .3s ease}
  @keyframes slideUp{from{transform:translateY(30px);opacity:0}to{transform:translateY(0);opacity:1}}
  .modal-header{padding:20px 24px;border-bottom:1px solid var(--border);display:flex;align-items:center;justify-content:space-between}
  .modal-title{font-family:'Rajdhani',sans-serif;font-size:1.3rem;font-weight:700}
  .modal-body{padding:24px}
  .close-btn{background:none;border:none;color:var(--muted);cursor:pointer;font-size:1.4rem;line-height:1}
  .close-btn:hover{color:var(--text)}

  /* FORM */
  .form-group{margin-bottom:16px}
  label{display:block;font-size:.82rem;color:var(--muted);margin-bottom:6px;font-weight:500}
  input,select,textarea{width:100%;background:var(--surface2);border:1px solid var(--border);border-radius:8px;color:var(--text);padding:10px 14px;font-family:'Be Vietnam Pro',sans-serif;font-size:.88rem;transition:border-color .2s}
  input:focus,select:focus,textarea:focus{outline:none;border-color:var(--accent)}
  select option{background:var(--surface2)}
  textarea{resize:vertical;min-height:80px}

  /* TOAST */
  .toast-container{position:fixed;bottom:24px;right:24px;z-index:999;display:flex;flex-direction:column;gap:8px}
  .toast{background:var(--surface);border:1px solid var(--border);border-radius:10px;padding:12px 16px;font-size:.85rem;display:flex;align-items:center;gap:10px;animation:toastIn .3s ease;max-width:300px}
  .toast.success{border-color:rgba(16,185,129,.4)}
  .toast.error{border-color:rgba(239,68,68,.4)}
  @keyframes toastIn{from{transform:translateX(100%);opacity:0}to{transform:translateX(0);opacity:1}}

  /* TABS */
  .tabs{display:flex;gap:4px;background:var(--surface2);border-radius:10px;padding:4px;margin-bottom:24px;flex-wrap:wrap}
  .tab{flex:1;min-width:100px;text-align:center;padding:8px;border-radius:7px;cursor:pointer;font-size:.85rem;transition:all .2s;border:none;background:none;color:var(--muted);font-family:'Be Vietnam Pro',sans-serif}
  .tab.active{background:var(--surface);color:var(--text);box-shadow:0 2px 8px rgba(0,0,0,.3)}

  /* ADMIN */
  .admin-panel{background:var(--surface);border:1px solid var(--border);border-radius:16px;padding:24px;margin-bottom:24px}
  .admin-title{font-family:'Rajdhani',sans-serif;font-size:1.2rem;font-weight:700;margin-bottom:16px;display:flex;align-items:center;gap:8px}
  .admin-title::before{content:'';width:4px;height:20px;background:var(--accent);border-radius:2px}
  .table{width:100%;border-collapse:collapse;font-size:.83rem}
  .table th{text-align:left;padding:8px 12px;color:var(--muted);border-bottom:1px solid var(--border);font-weight:500}
  .table td{padding:10px 12px;border-bottom:1px solid rgba(255,255,255,.04)}
  .table tr:hover td{background:rgba(255,255,255,.02)}

  /* N·∫†PTI·ªÄN */
  .recharge-grid{display:grid;grid-template-columns:1fr 1fr;gap:16px}
  .recharge-card{background:var(--surface2);border:1px solid var(--border);border-radius:12px;padding:20px;cursor:pointer;transition:all .2s;text-align:center}
  .recharge-card:hover,.recharge-card.selected{border-color:var(--accent);background:rgba(0,212,255,.05)}
  .recharge-icon{font-size:2rem;margin-bottom:8px}
  .recharge-name{font-weight:600;font-size:.9rem;margin-bottom:4px}
  .recharge-note{font-size:.75rem;color:var(--muted)}

  /* M√É T√ÄI KHO·∫¢N */
  .uid-box{background:linear-gradient(135deg,rgba(0,212,255,.1),rgba(124,58,237,.1));border:1px solid rgba(0,212,255,.2);border-radius:12px;padding:20px;text-align:center}
  .uid-label{font-size:.8rem;color:var(--muted);margin-bottom:8px}
  .uid-code{font-family:'Rajdhani',sans-serif;font-size:2rem;font-weight:700;color:var(--accent);letter-spacing:4px}
  .uid-copy{margin-top:12px}

  /* RESPONSIVE */
  @media(max-width:600px){
    .recharge-grid{grid-template-columns:1fr}
    .grid{grid-template-columns:1fr}
    .stats-bar{gap:16px}
  }

  /* LOGIN */
  .login-center{display:flex;align-items:center;justify-content:center;min-height:100vh;padding:24px}
  .login-card{background:var(--surface);border:1px solid var(--border);border-radius:24px;padding:40px;text-align:center;max-width:400px;width:100%}
  .login-logo{font-family:'Rajdhani',sans-serif;font-size:2.5rem;font-weight:700;color:var(--accent);margin-bottom:8px}
  .login-logo span{color:var(--gold)}
  .login-sub{color:var(--muted);font-size:.9rem;margin-bottom:32px}
  .google-btn{display:flex;align-items:center;justify-content:center;gap:12px;width:100%;padding:14px;background:#fff;color:#333;border-radius:10px;border:none;cursor:pointer;font-size:.95rem;font-weight:600;font-family:'Be Vietnam Pro',sans-serif;transition:all .2s}
  .google-btn:hover{background:#f1f5f9;transform:translateY(-1px)}
  .google-btn img{width:20px;height:20px}

  .shimmer{background:linear-gradient(90deg,var(--surface2) 25%,var(--surface) 50%,var(--surface2) 75%);background-size:200% 100%;animation:shimmer 1.5s infinite}
  @keyframes shimmer{0%{background-position:200% 0}100%{background-position:-200% 0}}

  .divider{display:flex;align-items:center;gap:12px;color:var(--muted);font-size:.8rem;margin:16px 0}
  .divider::before,.divider::after{content:'';flex:1;height:1px;background:var(--border)}

  .acc-detail-img{width:100%;height:200px;object-fit:cover;border-radius:12px;margin-bottom:16px;background:var(--surface2)}
  .acc-detail-row{display:flex;justify-content:space-between;padding:8px 0;border-bottom:1px solid rgba(255,255,255,.04);font-size:.85rem}
  .acc-detail-row:last-child{border:none}
  .acc-detail-key{color:var(--muted)}

  .no-items{text-align:center;padding:60px 24px;color:var(--muted)}
  .no-items-icon{font-size:3rem;margin-bottom:12px}

  .admin-badge{background:linear-gradient(135deg,var(--gold),#d97706);color:#000;font-size:.65rem;font-weight:700;padding:2px 6px;border-radius:4px;text-transform:uppercase;letter-spacing:1px}
</style>
</head>
<body>

<!-- NAV -->
<nav>
  <div class="nav-inner">
    <div class="logo">VN<span>SHOP</span> ACC</div>
    <div class="nav-right" id="navRight">
      <button class="btn btn-primary" onclick="openLoginModal()">
        <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm0 3c1.66 0 3 1.34 3 3s-1.34 3-3 3-3-1.34-3-3 1.34-3 3-3zm0 14.2c-2.5 0-4.71-1.28-6-3.22.03-1.99 4-3.08 6-3.08 1.99 0 5.97 1.09 6 3.08-1.29 1.94-3.5 3.22-6 3.22z"/></svg>
        ƒêƒÉng nh·∫≠p
      </button>
    </div>
  </div>
</nav>

<!-- LOGIN PAGE (full screen) -->
<div id="loginSection" class="section active">
  <div style="min-height:100vh;display:flex;align-items:center;justify-content:center;padding:24px;position:relative;z-index:1">
    <div style="position:fixed;inset:0;overflow:hidden;pointer-events:none;z-index:0">
      <div style="position:absolute;width:500px;height:500px;border-radius:50%;background:radial-gradient(circle,rgba(0,212,255,0.07),transparent);top:-150px;left:-150px;animation:bgpulse 7s ease-in-out infinite"></div>
      <div style="position:absolute;width:600px;height:600px;border-radius:50%;background:radial-gradient(circle,rgba(124,58,237,0.06),transparent);bottom:-200px;right:-200px;animation:bgpulse 9s ease-in-out infinite reverse"></div>
    </div>
    <style>@keyframes bgpulse{0%,100%{transform:scale(1);opacity:1}50%{transform:scale(1.1);opacity:.5}}</style>

    <div style="position:relative;z-index:1;width:100%;max-width:420px">
      <!-- Logo -->
      <div style="text-align:center;margin-bottom:36px">
        <div style="font-family:'Rajdhani',sans-serif;font-size:3.2rem;font-weight:700;color:var(--accent);letter-spacing:4px;text-shadow:0 0 40px rgba(0,212,255,0.5)">VN<span style="color:var(--gold)">SHOP</span></div>
        <div style="font-size:.82rem;color:var(--muted);letter-spacing:3px;text-transform:uppercase;margin-top:6px">Acc Li√™n Qu√¢n Mobile</div>
      </div>

      <!-- Card -->
      <div style="background:rgba(13,17,23,0.9);border:1px solid rgba(99,179,237,0.18);border-radius:24px;padding:36px;backdrop-filter:blur(24px);box-shadow:0 24px 80px rgba(0,0,0,0.6)">
        <div style="text-align:center;margin-bottom:28px">
          <div style="font-size:2.2rem;margin-bottom:8px">üëã</div>
          <div style="font-family:'Rajdhani',sans-serif;font-size:1.6rem;font-weight:700;margin-bottom:6px">Ch√†o m·ª´ng b·∫°n!</div>
          <div style="font-size:.84rem;color:var(--muted)">ƒêƒÉng nh·∫≠p ƒë·ªÉ mua acc &amp; n·∫°p ti·ªÅn v√†o shop</div>
        </div>

        <!-- Stats mini -->
        <div style="display:flex;justify-content:space-around;background:rgba(255,255,255,0.03);border:1px solid var(--border);border-radius:12px;padding:14px;margin-bottom:28px">
          <div style="text-align:center">
            <div style="font-family:'Rajdhani',sans-serif;font-size:1.5rem;font-weight:700;color:var(--accent)" id="statAcc">‚Äî</div>
            <div style="font-size:.68rem;color:var(--muted);margin-top:2px">ACC c√≥ s·∫µn</div>
          </div>
          <div style="width:1px;background:var(--border)"></div>
          <div style="text-align:center">
            <div style="font-family:'Rajdhani',sans-serif;font-size:1.5rem;font-weight:700;color:var(--gold)" id="statSold">‚Äî</div>
            <div style="font-size:.68rem;color:var(--muted);margin-top:2px">ƒê√£ b√°n</div>
          </div>
          <div style="width:1px;background:var(--border)"></div>
          <div style="text-align:center">
            <div style="font-family:'Rajdhani',sans-serif;font-size:1.5rem;font-weight:700;color:var(--success)">24/7</div>
            <div style="font-size:.68rem;color:var(--muted);margin-top:2px">H·ªó tr·ª£</div>
          </div>
        </div>

        <!-- Google Login Button -->
        <button id="googleLoginBtn" onclick="loginWithGoogle()" style="display:flex;align-items:center;justify-content:center;gap:14px;width:100%;padding:16px;background:#ffffff;color:#1f2937;border-radius:12px;border:none;cursor:pointer;font-size:1rem;font-weight:600;font-family:'Be Vietnam Pro',sans-serif;transition:all .25s;box-shadow:0 4px 24px rgba(0,0,0,0.4)">
          <img src="https://www.gstatic.com/firebasejs/ui/2.0.0/images/auth/google.svg" style="width:22px;height:22px;flex-shrink:0">
          <span>ƒêƒÉng nh·∫≠p b·∫±ng Google</span>
        </button>

        <div id="loginLoading" style="display:none;text-align:center;margin-top:14px;color:var(--muted);font-size:.84rem">
          <span style="display:inline-block;margin-right:6px">‚è≥</span>ƒêang m·ªü trang ƒëƒÉng nh·∫≠p Google...
        </div>

        <p style="text-align:center;font-size:.73rem;color:var(--muted);margin-top:20px;line-height:1.7">
          B·∫±ng c√°ch ƒëƒÉng nh·∫≠p, b·∫°n ƒë·ªìng √Ω v·ªõi ƒëi·ªÅu kho·∫£n s·ª≠ d·ª•ng c·ªßa shop.<br>Ch√∫ng t√¥i kh√¥ng l∆∞u m·∫≠t kh·∫©u c·ªßa b·∫°n.
        </p>
      </div>

      <!-- Feature badges -->
      <div style="display:grid;grid-template-columns:1fr 1fr 1fr;gap:10px;margin-top:16px">
        <div style="background:rgba(13,17,23,0.7);border:1px solid var(--border);border-radius:12px;padding:14px;text-align:center">
          <div style="font-size:1.5rem">‚öîÔ∏è</div>
          <div style="font-size:.7rem;color:var(--muted);margin-top:5px">Acc uy t√≠n</div>
        </div>
        <div style="background:rgba(13,17,23,0.7);border:1px solid var(--border);border-radius:12px;padding:14px;text-align:center">
          <div style="font-size:1.5rem">üîí</div>
          <div style="font-size:.7rem;color:var(--muted);margin-top:5px">B·∫£o m·∫≠t</div>
        </div>
        <div style="background:rgba(13,17,23,0.7);border:1px solid var(--border);border-radius:12px;padding:14px;text-align:center">
          <div style="font-size:1.5rem">üí∞</div>
          <div style="font-size:.7rem;color:var(--muted);margin-top:5px">Gi√° t·ªët</div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- USER SECTION -->
<div id="userSection" class="section">
  <div class="container">
    <div class="tabs">
      <button class="tab active" onclick="switchTab('shop')">üõí C·ª≠a h√†ng</button>
      <button class="tab" onclick="switchTab('recharge')">üí≥ N·∫°p ti·ªÅn</button>
      <button class="tab" onclick="switchTab('history')">üìã L·ªãch s·ª≠</button>
      <button class="tab" onclick="switchTab('profile')">üë§ T√†i kho·∫£n</button>
    </div>

    <!-- SHOP TAB -->
    <div id="tabShop">
      <div class="filter-bar" id="userFilter">
        <button class="filter-btn active" onclick="filterAccounts('all',this,'user')">T·∫•t c·∫£</button>
        <button class="filter-btn" onclick="filterAccounts('vip',this,'user')">VIP</button>
        <button class="filter-btn" onclick="filterAccounts('rank',this,'user')">Rank Cao</button>
        <button class="filter-btn" onclick="filterAccounts('cheap',this,'user')">Gi√° R·∫ª</button>
      </div>
      <div class="grid" id="userGrid"><div class="no-items"><div class="no-items-icon">‚öîÔ∏è</div>ƒêang t·∫£i...</div></div>
    </div>

    <!-- RECHARGE TAB -->
    <div id="tabRecharge" style="display:none">
      <div class="admin-panel">
        <div class="uid-box" id="uidBox">
          <div class="uid-label">M√£ t√†i kho·∫£n c·ªßa b·∫°n</div>
          <div class="uid-code" id="myUID">------</div>
          <div style="font-size:.75rem;color:var(--muted);margin-top:4px">G·ª≠i m√£ n√†y cho admin ƒë·ªÉ ƒë∆∞·ª£c c·ªông ti·ªÅn</div>
          <div class="uid-copy">
            <button class="btn btn-outline btn-sm" onclick="copyUID()">üìã Sao ch√©p m√£</button>
          </div>
        </div>
      </div>

      <div class="admin-panel">
        <div class="admin-title">Ch·ªçn ph∆∞∆°ng th·ª©c n·∫°p ti·ªÅn</div>
        <div class="recharge-grid">
          <div class="recharge-card" onclick="selectRecharge('card',this)">
            <div class="recharge-icon">üì±</div>
            <div class="recharge-name">Th·∫ª c√†o</div>
            <div class="recharge-note">Viettel, Garena, Zing,... (tr·ª´ 20% ph√≠)</div>
          </div>
          <div class="recharge-card" onclick="selectRecharge('bank',this)">
            <div class="recharge-icon">üè¶</div>
            <div class="recharge-name">Chuy·ªÉn kho·∫£n</div>
            <div class="recharge-note">Nh·∫≠n 100% gi√° tr·ªã</div>
          </div>
        </div>
      </div>

      <!-- TH·∫∫ C√ÄO -->
      <div class="admin-panel" id="cardForm" style="display:none">
        <div class="admin-title">N·∫°p th·∫ª c√†o</div>
        <div class="form-group">
          <label>Lo·∫°i th·∫ª</label>
          <select id="cardType">
            <option value="viettel">Viettel</option>
            <option value="garena">Garena</option>
            <option value="zing">Zing</option>
            <option value="vietnamobile">Vietnamobile</option>
            <option value="mobifone">Mobifone</option>
            <option value="vinaphone">Vinaphone</option>
          </select>
        </div>
        <div class="form-group">
          <label>M·ªánh gi√° th·∫ª</label>
          <select id="cardValue">
            <option value="10000">10.000ƒë ‚Üí nh·∫≠n 8.000ƒë</option>
            <option value="20000">20.000ƒë ‚Üí nh·∫≠n 16.000ƒë</option>
            <option value="50000">50.000ƒë ‚Üí nh·∫≠n 40.000ƒë</option>
            <option value="100000">100.000ƒë ‚Üí nh·∫≠n 80.000ƒë</option>
            <option value="200000">200.000ƒë ‚Üí nh·∫≠n 160.000ƒë</option>
            <option value="500000">500.000ƒë ‚Üí nh·∫≠n 400.000ƒë</option>
          </select>
        </div>
        <div class="form-group">
          <label>Seri th·∫ª</label>
          <input type="text" id="cardSerial" placeholder="Nh·∫≠p seri th·∫ª">
        </div>
        <div class="form-group">
          <label>M√£ th·∫ª</label>
          <input type="text" id="cardCode" placeholder="Nh·∫≠p m√£ th·∫ª">
        </div>
        <div style="background:rgba(245,158,11,.1);border:1px solid rgba(245,158,11,.2);border-radius:8px;padding:12px;font-size:.8rem;color:#fbbf24;margin-bottom:16px">
          ‚ö†Ô∏è Th·∫ª c√†o b·ªã tr·ª´ 20% ph√≠ x·ª≠ l√Ω. Vui l√≤ng g·ª≠i th·∫ª ƒë√∫ng seri & m√£, admin s·∫Ω x√°c nh·∫≠n trong v√≤ng 30 ph√∫t.
        </div>
        <button class="btn btn-primary" onclick="submitCard()" style="width:100%">G·ª≠i th·∫ª n·∫°p</button>
      </div>

      <!-- CHUY·ªÇN KHO·∫¢N -->
      <div class="admin-panel" id="bankForm" style="display:none">
        <div class="admin-title">Chuy·ªÉn kho·∫£n ng√¢n h√†ng</div>
        <div style="background:var(--surface2);border-radius:12px;padding:16px;margin-bottom:16px">
          <div class="acc-detail-row"><span class="acc-detail-key">Ng√¢n h√†ng</span><span style="font-weight:600">MB Bank / Vietcombank</span></div>
          <div class="acc-detail-row"><span class="acc-detail-key">S·ªë t√†i kho·∫£n</span><span style="font-weight:600;color:var(--accent)">0123456789</span></div>
          <div class="acc-detail-row"><span class="acc-detail-key">Ch·ªß t√†i kho·∫£n</span><span style="font-weight:600">NGUYEN PHUC</span></div>
          <div class="acc-detail-row"><span class="acc-detail-key">N·ªôi dung CK</span><span style="font-weight:600;color:var(--gold)" id="bankNote">MUA ACC + [UID]</span></div>
        </div>
        <div style="background:rgba(16,185,129,.1);border:1px solid rgba(16,185,129,.2);border-radius:8px;padding:12px;font-size:.8rem;color:#6ee7b7">
          ‚úÖ Chuy·ªÉn kho·∫£n nh·∫≠n ƒë·ªß 100% gi√° tr·ªã. Admin s·∫Ω c·ªông ti·ªÅn trong 5-15 ph√∫t sau khi nh·∫≠n ƒë∆∞·ª£c.
        </div>
      </div>
    </div>

    <!-- HISTORY TAB -->
    <div id="tabHistory" style="display:none">
      <div class="admin-panel">
        <div class="admin-title">L·ªãch s·ª≠ giao d·ªãch</div>
        <table class="table">
          <thead><tr><th>Th·ªùi gian</th><th>Lo·∫°i</th><th>S·ªë ti·ªÅn</th><th>Tr·∫°ng th√°i</th></tr></thead>
          <tbody id="historyBody"><tr><td colspan="4" style="text-align:center;color:var(--muted);padding:20px">Ch∆∞a c√≥ giao d·ªãch</td></tr></tbody>
        </table>
      </div>
    </div>

    <!-- PROFILE TAB -->
    <div id="tabProfile" style="display:none">
      <div class="admin-panel">
        <div class="admin-title">Th√¥ng tin t√†i kho·∫£n</div>
        <div style="display:flex;align-items:center;gap:16px;margin-bottom:20px">
          <img id="profileAvatar" src="" style="width:60px;height:60px;border-radius:50%;border:2px solid var(--accent)">
          <div>
            <div style="font-weight:600" id="profileName"></div>
            <div style="font-size:.82rem;color:var(--muted)" id="profileEmail"></div>
            <div id="profileAdminBadge" style="display:none;margin-top:4px"><span class="admin-badge">üëë Admin</span></div>
          </div>
        </div>
        <div class="uid-box" style="margin-bottom:16px">
          <div class="uid-label">M√£ t√†i kho·∫£n</div>
          <div class="uid-code" id="profileUID"></div>
        </div>
        <div class="acc-detail-row"><span class="acc-detail-key">S·ªë d∆∞</span><span style="color:var(--gold);font-weight:700;font-size:1.1rem" id="profileBalance">0ƒë</span></div>
        <div class="acc-detail-row"><span class="acc-detail-key">T·ªïng n·∫°p</span><span id="profileTotalIn">0ƒë</span></div>
        <div class="acc-detail-row"><span class="acc-detail-key">T·ªïng chi</span><span id="profileTotalOut">0ƒë</span></div>
        <button class="btn btn-outline" onclick="logout()" style="margin-top:16px;width:100%">ƒêƒÉng xu·∫•t</button>
      </div>
    </div>
  </div>
</div>

<!-- ADMIN SECTION -->
<div id="adminSection" class="section">
  <div class="container">
    <div style="display:flex;align-items:center;gap:12px;margin-bottom:24px">
      <div style="font-family:'Rajdhani',sans-serif;font-size:1.6rem;font-weight:700">B·∫£ng ƒëi·ªÅu khi·ªÉn Admin</div>
      <span class="admin-badge">üëë Admin</span>
    </div>
    <div class="tabs">
      <button class="tab active" onclick="switchAdminTab('accounts')">üéÆ Qu·∫£n l√Ω ACC</button>
      <button class="tab" onclick="switchAdminTab('users')">üë• Ng∆∞·ªùi d√πng</button>
      <button class="tab" onclick="switchAdminTab('recharges')">üí∞ N·∫°p ti·ªÅn</button>
      <button class="tab" onclick="switchAdminTab('lookup')">üîç Tra m√£</button>
    </div>

    <!-- MANAGE ACCOUNTS -->
    <div id="adminTabAccounts">
      <div class="admin-panel">
        <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:16px;flex-wrap:gap-8px">
          <div class="admin-title" style="margin:0">Danh s√°ch t√†i kho·∫£n</div>
          <button class="btn btn-primary btn-sm" onclick="openAddAccModal()">+ Th√™m ACC</button>
        </div>
        <table class="table">
          <thead><tr><th>T√™n ACC</th><th>Gi√°</th><th>Lo·∫°i</th><th>Tr·∫°ng th√°i</th><th>H√†nh ƒë·ªông</th></tr></thead>
          <tbody id="adminAccBody"><tr><td colspan="5" style="text-align:center;color:var(--muted);padding:20px">Ch∆∞a c√≥ t√†i kho·∫£n n√†o</td></tr></tbody>
        </table>
      </div>
    </div>

    <!-- USERS -->
    <div id="adminTabUsers" style="display:none">
      <div class="admin-panel">
        <div class="admin-title">Ng∆∞·ªùi d√πng</div>
        <table class="table">
          <thead><tr><th>T√™n</th><th>Email</th><th>M√£ UID</th><th>S·ªë d∆∞</th><th>H√†nh ƒë·ªông</th></tr></thead>
          <tbody id="adminUserBody"><tr><td colspan="5" style="text-align:center;color:var(--muted);padding:20px">Ch∆∞a c√≥ ng∆∞·ªùi d√πng</td></tr></tbody>
        </table>
      </div>
    </div>

    <!-- RECHARGES -->
    <div id="adminTabRecharges" style="display:none">
      <div class="admin-panel">
        <div class="admin-title">Y√™u c·∫ßu n·∫°p ti·ªÅn</div>
        <table class="table">
          <thead><tr><th>Th·ªùi gian</th><th>Email</th><th>UID</th><th>Lo·∫°i</th><th>Gi√° tr·ªã</th><th>Tr·∫°ng th√°i</th><th>Duy·ªát</th></tr></thead>
          <tbody id="adminRechargeBody"><tr><td colspan="7" style="text-align:center;color:var(--muted);padding:20px">Ch∆∞a c√≥ y√™u c·∫ßu</td></tr></tbody>
        </table>
      </div>
    </div>

    <!-- LOOKUP -->
    <div id="adminTabLookup" style="display:none">
      <div class="admin-panel">
        <div class="admin-title">Tra m√£ t√†i kho·∫£n & C·ªông ti·ªÅn</div>
        <div style="display:flex;gap:12px;margin-bottom:20px;flex-wrap:wrap">
          <input type="text" id="lookupUID" placeholder="Nh·∫≠p m√£ UID (VD: ABC123)" style="flex:1;min-width:200px">
          <button class="btn btn-primary" onclick="lookupUser()">üîç Tra c·ª©u</button>
        </div>
        <div id="lookupResult" style="display:none">
          <div style="background:var(--surface2);border-radius:12px;padding:16px;margin-bottom:16px">
            <div style="display:flex;align-items:center;gap:12px;margin-bottom:12px">
              <img id="lookupAvatar" src="" style="width:40px;height:40px;border-radius:50%">
              <div>
                <div style="font-weight:600" id="lookupName"></div>
                <div style="font-size:.8rem;color:var(--muted)" id="lookupEmail"></div>
              </div>
            </div>
            <div class="acc-detail-row"><span class="acc-detail-key">S·ªë d∆∞ hi·ªán t·∫°i</span><span style="color:var(--gold);font-weight:700" id="lookupBalance"></span></div>
          </div>
          <div style="display:flex;gap:12px;flex-wrap:wrap">
            <input type="number" id="addAmount" placeholder="S·ªë ti·ªÅn c·ªông th√™m (ƒë)" style="flex:1;min-width:150px">
            <button class="btn btn-success" onclick="addBalance()">üí∞ C·ªông ti·ªÅn</button>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- ADD ACC MODAL -->
<div class="modal-overlay" id="addAccModal">
  <div class="modal">
    <div class="modal-header">
      <div class="modal-title">Th√™m t√†i kho·∫£n m·ªõi</div>
      <button class="close-btn" onclick="closeModal('addAccModal')">‚úï</button>
    </div>
    <div class="modal-body">
      <div class="form-group">
        <label>T√™n t√†i kho·∫£n</label>
        <input type="text" id="newAccName" placeholder="VD: ACC Rank Thi√™n V∆∞∆°ng - 50 T∆∞·ªõng">
      </div>
      <div class="form-group">
        <label>M√¥ t·∫£ chi ti·∫øt</label>
        <textarea id="newAccDesc" placeholder="M√¥ t·∫£ t∆∞·ªõng, skin, rank, server..."></textarea>
      </div>
      <div class="form-group">
        <label>Gi√° b√°n (ƒë)</label>
        <input type="number" id="newAccPrice" placeholder="VD: 150000">
      </div>
      <div class="form-group">
        <label>Lo·∫°i t√†i kho·∫£n</label>
        <select id="newAccType">
          <option value="vip">VIP</option>
          <option value="rank">Rank Cao</option>
          <option value="cheap">Gi√° R·∫ª</option>
          <option value="normal">B√¨nh th∆∞·ªùng</option>
        </select>
      </div>
      <div class="form-group">
        <label>Badge</label>
        <select id="newAccBadge">
          <option value="new">üÜï M·ªõi</option>
          <option value="hot">üî• Hot</option>
          <option value="">Kh√¥ng c√≥</option>
        </select>
      </div>
      <div class="form-group">
        <label>Tags (ph√¢n c√°ch b·∫±ng d·∫•u ph·∫©y)</label>
        <input type="text" id="newAccTags" placeholder="VD: 50 t∆∞·ªõng, 20 skin, rank TV">
      </div>
      <div class="form-group">
        <label>URL h√¨nh ·∫£nh (tu·ª≥ ch·ªçn)</label>
        <input type="text" id="newAccImg" placeholder="https://...">
      </div>
      <div class="form-group">
        <label>Th√¥ng tin ƒëƒÉng nh·∫≠p ACC (ri√™ng t∆∞, ch·ªâ g·ª≠i sau mua)</label>
        <textarea id="newAccLogin" placeholder="Username / Password / Email c·ªßa t√†i kho·∫£n game"></textarea>
      </div>
      <button class="btn btn-primary" onclick="addAccount()" style="width:100%">Th√™m t√†i kho·∫£n</button>
    </div>
  </div>
</div>

<!-- ACC DETAIL MODAL -->
<div class="modal-overlay" id="accDetailModal">
  <div class="modal">
    <div class="modal-header">
      <div class="modal-title" id="detailTitle"></div>
      <button class="close-btn" onclick="closeModal('accDetailModal')">‚úï</button>
    </div>
    <div class="modal-body" id="detailBody"></div>
  </div>
</div>

<!-- ADD BALANCE MODAL (admin to user) -->
<div class="modal-overlay" id="addBalanceModal">
  <div class="modal" style="max-width:380px">
    <div class="modal-header">
      <div class="modal-title">C·ªông ti·ªÅn cho ng∆∞·ªùi d√πng</div>
      <button class="close-btn" onclick="closeModal('addBalanceModal')">‚úï</button>
    </div>
    <div class="modal-body">
      <div style="font-size:.85rem;color:var(--muted);margin-bottom:12px" id="addBalanceFor"></div>
      <div class="form-group">
        <label>S·ªë ti·ªÅn c·ªông (ƒë)</label>
        <input type="number" id="directAddAmount" placeholder="Nh·∫≠p s·ªë ti·ªÅn">
      </div>
      <button class="btn btn-success" onclick="confirmDirectAdd()" style="width:100%">X√°c nh·∫≠n c·ªông ti·ªÅn</button>
    </div>
  </div>
</div>

<!-- TOAST -->
<div class="toast-container" id="toastContainer"></div>

<!-- FIREBASE -->
<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
import { getAnalytics } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-analytics.js";
import { getAuth, GoogleAuthProvider, signInWithPopup, signInWithRedirect, getRedirectResult, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
import { getDatabase, ref, set, get, update, push, onValue, serverTimestamp, query, orderByChild, equalTo } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-database.js";

const firebaseConfig = {
  apiKey: "AIzaSyCDQsJ_NrGK5ouRLS7vFr55OBZQ0nKhHSk",
  authDomain: "vietnam-life-game.firebaseapp.com",
  databaseURL: "https://vietnam-life-game-default-rtdb.asia-southeast1.firebasedatabase.app",
  projectId: "vietnam-life-game",
  storageBucket: "vietnam-life-game.firebasestorage.app",
  messagingSenderId: "134954120781",
  appId: "1:134954120781:web:d7f762adb80bfce3140e04",
  measurementId: "G-39VPPE1F9T"
};

const app = initializeApp(firebaseConfig);
const analytics = getAnalytics(app);
const auth = getAuth(app);
const db = getDatabase(app);
const ADMIN_EMAIL = "nguyenphuc10092012@gmail.com";

let currentUser = null;
let currentUserData = null;
let allAccounts = [];
let allUsers = {};
let selectedRechargeType = null;
let lookupUserData = null;
let lookupUserKey = null;
let directAddTarget = null;

// GENERATE UID
function generateUID() {
  const chars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789';
  let uid = '';
  for (let i = 0; i < 6; i++) uid += chars[Math.floor(Math.random() * chars.length)];
  return uid;
}

// FORMAT MONEY
function fmtMoney(n) {
  return Number(n).toLocaleString('vi-VN') + 'ƒë';
}

// TOAST
window.showToast = function(msg, type='success') {
  const c = document.getElementById('toastContainer');
  const t = document.createElement('div');
  t.className = `toast ${type}`;
  t.innerHTML = `<span>${type==='success'?'‚úÖ':'‚ùå'}</span>${msg}`;
  c.appendChild(t);
  setTimeout(() => t.remove(), 4000);
};

// X·ª≠ l√Ω redirect result khi trang load l·∫°i
getRedirectResult(auth).then(result => {
  if (result?.user) closeModal('loginModal');
}).catch(e => {
  if (e.code !== 'auth/no-current-user') console.error(e);
});

// AUTH
window.loginWithGoogle = async function() {
  const btn = document.getElementById('googleLoginBtn');
  const loading = document.getElementById('loginLoading');
  if (btn) { btn.disabled = true; btn.style.opacity = '.7'; btn.style.cursor = 'not-allowed'; }
  if (loading) loading.style.display = 'block';
  const provider = new GoogleAuthProvider();
  provider.setCustomParameters({ prompt: 'select_account' });
  try {
    await signInWithPopup(auth, provider);
  } catch(e) {
    if (e.code === 'auth/popup-blocked' || e.code === 'auth/popup-closed-by-user' || e.code === 'auth/cancelled-popup-request') {
      try { await signInWithRedirect(auth, provider); } catch(e2) { showToast('L·ªói: ' + e2.message, 'error'); }
    } else if (e.code !== 'auth/cancelled-popup-request') {
      showToast('ƒêƒÉng nh·∫≠p th·∫•t b·∫°i: ' + e.message, 'error');
    }
    if (btn) { btn.disabled = false; btn.style.opacity = '1'; btn.style.cursor = 'pointer'; }
    if (loading) loading.style.display = 'none';
  }
};

window.logout = async function() {
  await signOut(auth);
};

window.openLoginModal = function() { showSection('loginSection'); };

onAuthStateChanged(auth, async user => {
  if (user) {
    currentUser = user;
    await ensureUserExists(user);
    await loadUserData(user.uid);
    updateNav(user);
    if (user.email === ADMIN_EMAIL) {
      showSection('adminSection');
      loadAdminData();
    } else {
      showSection('userSection');
      loadUserSection();
    }
  } else {
    currentUser = null;
    currentUserData = null;
    showSection('loginSection');
    loadPublicAccounts();
    document.getElementById('navRight').innerHTML = '';
  }
});

async function ensureUserExists(user) {
  const snap = await get(ref(db, `users/${user.uid}`));
  if (!snap.exists()) {
    let uid;
    // ensure unique UID
    let tries = 0;
    do {
      uid = generateUID();
      tries++;
      const check = await get(ref(db, `uidMap/${uid}`));
      if (!check.exists()) break;
    } while(tries < 20);
    await set(ref(db, `users/${user.uid}`), {
      name: user.displayName,
      email: user.email,
      avatar: user.photoURL,
      uid: uid,
      balance: 0,
      totalIn: 0,
      totalOut: 0,
      createdAt: Date.now()
    });
    await set(ref(db, `uidMap/${uid}`), user.uid);
  }
}

async function loadUserData(uid) {
  const snap = await get(ref(db, `users/${uid}`));
  currentUserData = snap.val();
}

function updateNav(user) {
  const isAdmin = user.email === ADMIN_EMAIL;
  document.getElementById('navRight').innerHTML = `
    <div class="balance-chip" id="navBalance">${fmtMoney(currentUserData?.balance||0)}</div>
    <div class="user-chip">
      <img src="${user.photoURL||''}" alt="" class="user-avatar">
      <span>${user.displayName?.split(' ').slice(-1)[0] || 'User'}</span>
      ${isAdmin?'<span class="admin-badge">Admin</span>':''}
    </div>
    <button class="btn btn-outline btn-sm" onclick="logout()">Tho√°t</button>
  `;
}

// SECTIONS
function showSection(id) {
  document.querySelectorAll('.section').forEach(s=>s.classList.remove('active'));
  document.getElementById(id).classList.add('active');
}

// LOAD PUBLIC ACCOUNTS
async function loadPublicAccounts() {
  const snap = await get(ref(db,'accounts'));
  const all = snap.val() ? Object.entries(snap.val()) : [];
  allAccounts = all;
  const total = all.length;
  const sold = all.filter(([k,v])=>v.sold).length;
  document.getElementById('statAcc').textContent = total;
  document.getElementById('statSold').textContent = sold;
  renderGrid('publicGrid', all, false);
}

function renderGrid(gridId, accounts, canBuy) {
  const grid = document.getElementById(gridId);
  if (!accounts.length) {
    grid.innerHTML = '<div class="no-items"><div class="no-items-icon">‚öîÔ∏è</div>Ch∆∞a c√≥ t√†i kho·∫£n n√†o</div>';
    return;
  }
  grid.innerHTML = accounts.map(([key,acc])=>`
    <div class="acc-card ${acc.sold?'sold':''}" onclick="openAccDetail('${key}')">
      ${acc.badge ? `<div class="card-badge ${acc.badge==='hot'?'badge-hot':acc.badge==='new'?'badge-new':''}">${acc.badge==='hot'?'üî• Hot':'üÜï M·ªõi'}</div>` : ''}
      ${acc.sold ? '<div class="card-badge badge-sold">ƒê√£ b√°n</div>' : ''}
      ${acc.img ? `<img src="${acc.img}" class="card-img" alt="">` : `<div class="card-img-placeholder">‚öîÔ∏è</div>`}
      <div class="card-body">
        <div class="card-title">${acc.name}</div>
        <div class="card-desc">${(acc.desc||'').substring(0,80)}${acc.desc&&acc.desc.length>80?'...':''}</div>
        ${acc.tags ? `<div class="card-tags">${acc.tags.split(',').map(t=>`<span class="tag">${t.trim()}</span>`).join('')}</div>` : ''}
        <div class="card-price">
          <div class="price">${fmtMoney(acc.price)}</div>
          ${!acc.sold&&canBuy?`<button class="btn btn-gold btn-sm" onclick="event.stopPropagation();buyAcc('${key}')">Mua</button>`:''}
        </div>
      </div>
    </div>
  `).join('');
}

// FILTER
window.filterAccounts = function(type, btn, scope='public') {
  const btns = scope==='user' ? document.querySelectorAll('#userFilter .filter-btn') : document.querySelectorAll('#publicFilter .filter-btn');
  btns.forEach(b=>b.classList.remove('active'));
  btn.classList.add('active');
  let filtered = allAccounts;
  if (type !== 'all') {
    if (type==='cheap') filtered = allAccounts.filter(([k,v])=>v.price<=100000);
    else filtered = allAccounts.filter(([k,v])=>v.type===type);
  }
  renderGrid(scope==='user'?'userGrid':'publicGrid', filtered, scope==='user');
};

// USER SECTION
async function loadUserSection() {
  const snap = await get(ref(db,'accounts'));
  const all = snap.val() ? Object.entries(snap.val()) : [];
  allAccounts = all;
  renderGrid('userGrid', all, true);
  // Update UID
  if (currentUserData) {
    document.getElementById('myUID').textContent = currentUserData.uid;
    document.getElementById('profileUID').textContent = currentUserData.uid;
    document.getElementById('bankNote').textContent = `MUA ACC ${currentUserData.uid}`;
    document.getElementById('navBalance').textContent = fmtMoney(currentUserData.balance||0);
    // Profile
    document.getElementById('profileName').textContent = currentUser.displayName;
    document.getElementById('profileEmail').textContent = currentUser.email;
    document.getElementById('profileAvatar').src = currentUser.photoURL||'';
    document.getElementById('profileBalance').textContent = fmtMoney(currentUserData.balance||0);
    document.getElementById('profileTotalIn').textContent = fmtMoney(currentUserData.totalIn||0);
    document.getElementById('profileTotalOut').textContent = fmtMoney(currentUserData.totalOut||0);
  }
  // Load history
  loadHistory();
}

async function loadHistory() {
  const snap = await get(ref(db,`transactions/${currentUser.uid}`));
  const tbody = document.getElementById('historyBody');
  if (!snap.exists()) { tbody.innerHTML = '<tr><td colspan="4" style="text-align:center;color:var(--muted);padding:20px">Ch∆∞a c√≥ giao d·ªãch</td></tr>'; return; }
  const txs = Object.values(snap.val()).sort((a,b)=>b.time-a.time);
  tbody.innerHTML = txs.map(tx=>`
    <tr>
      <td>${new Date(tx.time).toLocaleString('vi-VN')}</td>
      <td>${tx.type}</td>
      <td style="color:${tx.amount>0?'var(--success)':'var(--danger)'}">${tx.amount>0?'+':''}${fmtMoney(tx.amount)}</td>
      <td><span style="color:${tx.status==='done'?'var(--success)':'var(--gold)'}">${tx.status==='done'?'‚úÖ Xong':'‚è≥ Ch·ªù'}</span></td>
    </tr>
  `).join('');
}

// TABS
window.switchTab = function(tab) {
  ['shop','recharge','history','profile'].forEach(t=>{
    document.getElementById('tab'+t.charAt(0).toUpperCase()+t.slice(1)).style.display = t===tab?'block':'none';
  });
  document.querySelectorAll('#userSection .tab').forEach((b,i)=>{
    b.classList.toggle('active', ['shop','recharge','history','profile'][i]===tab);
  });
  if (tab==='history') loadHistory();
};

window.switchAdminTab = function(tab) {
  ['accounts','users','recharges','lookup'].forEach(t=>{
    document.getElementById('adminTab'+t.charAt(0).toUpperCase()+t.slice(1)).style.display = t===tab?'block':'none';
  });
  document.querySelectorAll('#adminSection .tab').forEach((b,i)=>{
    b.classList.toggle('active', ['accounts','users','recharges','lookup'][i]===tab);
  });
};

// RECHARGE
window.selectRecharge = function(type, el) {
  selectedRechargeType = type;
  document.querySelectorAll('.recharge-card').forEach(c=>c.classList.remove('selected'));
  el.classList.add('selected');
  document.getElementById('cardForm').style.display = type==='card'?'block':'none';
  document.getElementById('bankForm').style.display = type==='bank'?'block':'none';
};

window.copyUID = function() {
  navigator.clipboard.writeText(currentUserData?.uid||'').then(()=>showToast('ƒê√£ sao ch√©p m√£ UID'));
};

window.submitCard = async function() {
  const cardType = document.getElementById('cardType').value;
  const cardValue = parseInt(document.getElementById('cardValue').value);
  const serial = document.getElementById('cardSerial').value.trim();
  const code = document.getElementById('cardCode').value.trim();
  if (!serial || !code) { showToast('Vui l√≤ng nh·∫≠p ƒë·∫ßy ƒë·ªß th√¥ng tin th·∫ª','error'); return; }
  const netValue = Math.floor(cardValue * 0.8);
  const txRef = push(ref(db,`recharges`));
  await set(txRef, {
    uid: currentUserData.uid,
    userUid: currentUser.uid,
    email: currentUser.email,
    type: 'card',
    cardType, cardValue, serial, code, netValue,
    status: 'pending',
    time: Date.now()
  });
  await push(ref(db,`transactions/${currentUser.uid}`), {
    type: `Th·∫ª c√†o ${cardType} ${fmtMoney(cardValue)}`,
    amount: netValue,
    status: 'pending',
    time: Date.now()
  });
  document.getElementById('cardSerial').value = '';
  document.getElementById('cardCode').value = '';
  showToast(`ƒê√£ g·ª≠i th·∫ª! Sau khi duy·ªát b·∫°n s·∫Ω nh·∫≠n ${fmtMoney(netValue)}`);
};

// BUY ACC
window.buyAcc = async function(key) {
  if (!currentUser) { showSection('loginSection'); return; }
  const snap = await get(ref(db,`accounts/${key}`));
  const acc = snap.val();
  if (!acc || acc.sold) { showToast('T√†i kho·∫£n ƒë√£ b√°n','error'); return; }
  if ((currentUserData?.balance||0) < acc.price) {
    showToast(`S·ªë d∆∞ kh√¥ng ƒë·ªß! C·∫ßn ${fmtMoney(acc.price)}, b·∫°n c√≥ ${fmtMoney(currentUserData?.balance||0)}`,'error');
    return;
  }
  if (!confirm(`Mua "${acc.name}" v·ªõi gi√° ${fmtMoney(acc.price)}?`)) return;
  const newBal = (currentUserData.balance||0) - acc.price;
  await update(ref(db,`users/${currentUser.uid}`), {
    balance: newBal,
    totalOut: (currentUserData.totalOut||0) + acc.price
  });
  await update(ref(db,`accounts/${key}`), { sold: true, buyer: currentUser.email, soldAt: Date.now() });
  await push(ref(db,`transactions/${currentUser.uid}`), {
    type: `Mua ACC: ${acc.name}`,
    amount: -acc.price,
    status: 'done',
    loginInfo: acc.loginInfo||'',
    time: Date.now()
  });
  currentUserData.balance = newBal;
  currentUserData.totalOut = (currentUserData.totalOut||0) + acc.price;
  await loadUserData(currentUser.uid);
  document.getElementById('navBalance').textContent = fmtMoney(currentUserData.balance||0);
  document.getElementById('profileBalance').textContent = fmtMoney(currentUserData.balance||0);
  showToast(`Mua th√†nh c√¥ng! Th√¥ng tin ƒëƒÉng nh·∫≠p ƒë√£ l∆∞u trong l·ªãch s·ª≠`);
  loadUserSection();
};

// ACC DETAIL
window.openAccDetail = function(key) {
  const acc = allAccounts.find(([k])=>k===key)?.[1];
  if (!acc) return;
  document.getElementById('detailTitle').textContent = acc.name;
  document.getElementById('detailBody').innerHTML = `
    ${acc.img ? `<img src="${acc.img}" class="acc-detail-img" alt="">` : `<div style="width:100%;height:140px;background:var(--surface2);border-radius:12px;display:flex;align-items:center;justify-content:center;font-size:3rem;margin-bottom:16px">‚öîÔ∏è</div>`}
    <div class="acc-detail-row"><span class="acc-detail-key">Tr·∫°ng th√°i</span><span style="color:${acc.sold?'var(--danger)':'var(--success)'}">${acc.sold?'‚ùå ƒê√£ b√°n':'‚úÖ C√≤n h√†ng'}</span></div>
    <div class="acc-detail-row"><span class="acc-detail-key">Gi√° b√°n</span><span style="color:var(--gold);font-weight:700;font-size:1.1rem">${fmtMoney(acc.price)}</span></div>
    <div class="acc-detail-row"><span class="acc-detail-key">Lo·∫°i</span><span>${acc.type||'normal'}</span></div>
    <div style="padding:12px 0;font-size:.88rem;line-height:1.7;color:var(--muted)">${acc.desc||''}</div>
    ${acc.tags ? `<div class="card-tags" style="margin-top:8px">${acc.tags.split(',').map(t=>`<span class="tag">${t.trim()}</span>`).join('')}</div>` : ''}
    ${currentUser && !acc.sold ? `<button class="btn btn-gold" style="width:100%;margin-top:20px;font-size:1rem;padding:12px" onclick="closeModal('accDetailModal');buyAcc('${key}')">Mua ngay ‚Äì ${fmtMoney(acc.price)}</button>` : ''}
    ${!currentUser && !acc.sold ? `<button class="btn btn-primary" style="width:100%;margin-top:20px" onclick="closeModal('accDetailModal');showSection('loginSection')">ƒêƒÉng nh·∫≠p ƒë·ªÉ mua</button>` : ''}
  `;
  document.getElementById('accDetailModal').classList.add('open');
};

// ADMIN
window.openAddAccModal = function() {
  document.getElementById('addAccModal').classList.add('open');
};

window.addAccount = async function() {
  const name = document.getElementById('newAccName').value.trim();
  const desc = document.getElementById('newAccDesc').value.trim();
  const price = parseInt(document.getElementById('newAccPrice').value);
  const type = document.getElementById('newAccType').value;
  const badge = document.getElementById('newAccBadge').value;
  const tags = document.getElementById('newAccTags').value.trim();
  const img = document.getElementById('newAccImg').value.trim();
  const loginInfo = document.getElementById('newAccLogin').value.trim();
  if (!name || !price) { showToast('Vui l√≤ng nh·∫≠p t√™n v√† gi√°','error'); return; }
  await push(ref(db,'accounts'), {
    name, desc, price, type, badge, tags, img, loginInfo,
    sold: false, createdAt: Date.now()
  });
  showToast('ƒê√£ th√™m t√†i kho·∫£n!');
  closeModal('addAccModal');
  loadAdminData();
  ['newAccName','newAccDesc','newAccPrice','newAccTags','newAccImg','newAccLogin'].forEach(id=>document.getElementById(id).value='');
};

async function loadAdminData() {
  // Accounts
  const accSnap = await get(ref(db,'accounts'));
  const accs = accSnap.val() ? Object.entries(accSnap.val()) : [];
  allAccounts = accs;
  const tbody = document.getElementById('adminAccBody');
  if (!accs.length) { tbody.innerHTML = '<tr><td colspan="5" style="text-align:center;color:var(--muted);padding:20px">Ch∆∞a c√≥ t√†i kho·∫£n n√†o</td></tr>'; }
  else {
    tbody.innerHTML = accs.map(([key,acc])=>`
      <tr>
        <td style="font-weight:600">${acc.name}</td>
        <td style="color:var(--gold)">${fmtMoney(acc.price)}</td>
        <td>${acc.type||'-'}</td>
        <td><span style="color:${acc.sold?'var(--danger)':'var(--success)'}">${acc.sold?'ƒê√£ b√°n':'C√≤n h√†ng'}</span></td>
        <td><button class="btn btn-danger btn-sm" onclick="deleteAcc('${key}')">Xo√°</button></td>
      </tr>
    `).join('');
  }

  // Users
  const userSnap = await get(ref(db,'users'));
  const users = userSnap.val() ? Object.entries(userSnap.val()) : [];
  allUsers = userSnap.val()||{};
  const userBody = document.getElementById('adminUserBody');
  if (!users.length) { userBody.innerHTML = '<tr><td colspan="5" style="text-align:center;color:var(--muted);padding:20px">Ch∆∞a c√≥ ng∆∞·ªùi d√πng</td></tr>'; }
  else {
    userBody.innerHTML = users.map(([uid,u])=>`
      <tr>
        <td>${u.name}</td>
        <td style="font-size:.8rem;color:var(--muted)">${u.email}</td>
        <td><code style="background:var(--surface2);padding:2px 6px;border-radius:4px;color:var(--accent)">${u.uid}</code></td>
        <td style="color:var(--gold)">${fmtMoney(u.balance||0)}</td>
        <td><button class="btn btn-success btn-sm" onclick="openDirectAdd('${uid}','${u.name}','${u.email}')">C·ªông ti·ªÅn</button></td>
      </tr>
    `).join('');
  }

  // Recharges
  const rSnap = await get(ref(db,'recharges'));
  const recharges = rSnap.val() ? Object.entries(rSnap.val()) : [];
  const rBody = document.getElementById('adminRechargeBody');
  if (!recharges.length) { rBody.innerHTML = '<tr><td colspan="7" style="text-align:center;color:var(--muted);padding:20px">Ch∆∞a c√≥ y√™u c·∫ßu</td></tr>'; }
  else {
    rBody.innerHTML = recharges.sort((a,b)=>b[1].time-a[1].time).map(([key,r])=>`
      <tr>
        <td style="font-size:.78rem">${new Date(r.time).toLocaleString('vi-VN')}</td>
        <td style="font-size:.78rem;color:var(--muted)">${r.email}</td>
        <td><code style="color:var(--accent)">${r.uid}</code></td>
        <td>${r.cardType||'bank'}</td>
        <td style="color:var(--gold)">${fmtMoney(r.cardValue||0)}</td>
        <td><span style="color:${r.status==='done'?'var(--success)':'var(--gold)'}">${r.status==='done'?'‚úÖ Xong':'‚è≥ Ch·ªù'}</span></td>
        <td>${r.status!=='done'?`<button class="btn btn-success btn-sm" onclick="approveRecharge('${key}','${r.userUid}',${r.netValue||0})">Duy·ªát</button>`:''}</td>
      </tr>
    `).join('');
  }
}

window.deleteAcc = async function(key) {
  if (!confirm('X√°c nh·∫≠n xo√° t√†i kho·∫£n n√†y?')) return;
  await update(ref(db,`accounts/${key}`),{deleted:true,sold:true});
  showToast('ƒê√£ xo√°!');
  loadAdminData();
};

window.approveRecharge = async function(key, userUid, amount) {
  const userSnap = await get(ref(db,`users/${userUid}`));
  const user = userSnap.val();
  if (!user) { showToast('Kh√¥ng t√¨m th·∫•y ng∆∞·ªùi d√πng','error'); return; }
  const newBal = (user.balance||0) + amount;
  await update(ref(db,`users/${userUid}`), {
    balance: newBal,
    totalIn: (user.totalIn||0) + amount
  });
  await update(ref(db,`recharges/${key}`), { status:'done', approvedAt: Date.now() });
  // update transaction status
  const txSnap = await get(ref(db,`transactions/${userUid}`));
  if (txSnap.exists()) {
    const txs = Object.entries(txSnap.val());
    const pending = txs.find(([k,v])=>v.status==='pending'&&v.amount===amount);
    if (pending) await update(ref(db,`transactions/${userUid}/${pending[0]}`),{status:'done'});
  }
  showToast(`ƒê√£ c·ªông ${fmtMoney(amount)} cho ${user.email}`);
  loadAdminData();
};

// LOOKUP
window.lookupUser = async function() {
  const uid = document.getElementById('lookupUID').value.trim().toUpperCase();
  if (!uid) { showToast('Nh·∫≠p m√£ UID','error'); return; }
  const mapSnap = await get(ref(db,`uidMap/${uid}`));
  if (!mapSnap.exists()) { showToast('Kh√¥ng t√¨m th·∫•y m√£ UID','error'); document.getElementById('lookupResult').style.display='none'; return; }
  const fbUid = mapSnap.val();
  const userSnap = await get(ref(db,`users/${fbUid}`));
  lookupUserData = userSnap.val();
  lookupUserKey = fbUid;
  const res = document.getElementById('lookupResult');
  res.style.display = 'block';
  document.getElementById('lookupName').textContent = lookupUserData.name;
  document.getElementById('lookupEmail').textContent = lookupUserData.email;
  document.getElementById('lookupAvatar').src = lookupUserData.avatar||'';
  document.getElementById('lookupBalance').textContent = fmtMoney(lookupUserData.balance||0);
};

window.addBalance = async function() {
  const amount = parseInt(document.getElementById('addAmount').value);
  if (!amount||amount<=0) { showToast('Nh·∫≠p s·ªë ti·ªÅn h·ª£p l·ªá','error'); return; }
  if (!lookupUserKey||!lookupUserData) return;
  const newBal = (lookupUserData.balance||0) + amount;
  await update(ref(db,`users/${lookupUserKey}`), {
    balance: newBal,
    totalIn: (lookupUserData.totalIn||0) + amount
  });
  await push(ref(db,`transactions/${lookupUserKey}`), {
    type: 'Admin c·ªông ti·ªÅn',
    amount,
    status: 'done',
    time: Date.now()
  });
  lookupUserData.balance = newBal;
  document.getElementById('lookupBalance').textContent = fmtMoney(newBal);
  document.getElementById('addAmount').value = '';
  showToast(`ƒê√£ c·ªông ${fmtMoney(amount)} cho ${lookupUserData.email}`);
};

// DIRECT ADD
window.openDirectAdd = function(uid, name, email) {
  directAddTarget = { uid, name, email };
  document.getElementById('addBalanceFor').textContent = `C·ªông ti·ªÅn cho: ${name} (${email})`;
  document.getElementById('addBalanceModal').classList.add('open');
};

window.confirmDirectAdd = async function() {
  const amount = parseInt(document.getElementById('directAddAmount').value);
  if (!amount||amount<=0||!directAddTarget) { showToast('Nh·∫≠p s·ªë ti·ªÅn h·ª£p l·ªá','error'); return; }
  const snap = await get(ref(db,`users/${directAddTarget.uid}`));
  const user = snap.val();
  const newBal = (user.balance||0) + amount;
  await update(ref(db,`users/${directAddTarget.uid}`), {
    balance: newBal,
    totalIn: (user.totalIn||0) + amount
  });
  await push(ref(db,`transactions/${directAddTarget.uid}`), {
    type: 'Admin c·ªông ti·ªÅn',
    amount,
    status: 'done',
    time: Date.now()
  });
  showToast(`ƒê√£ c·ªông ${fmtMoney(amount)} cho ${directAddTarget.email}`);
  closeModal('addBalanceModal');
  document.getElementById('directAddAmount').value = '';
  loadAdminData();
};

// CLOSE MODAL
window.closeModal = function(id) {
  document.getElementById(id).classList.remove('open');
};

// CLOSE ON OVERLAY CLICK
document.querySelectorAll('.modal-overlay').forEach(overlay => {
  overlay.addEventListener('click', function(e) {
    if (e.target === overlay) overlay.classList.remove('open');
  });
});

// Initial load
loadPublicAccounts();
</script>
</body>
</html>
